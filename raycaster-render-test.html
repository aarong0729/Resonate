<!DOCTYPE html>
<html>
<head>
    <title>Render Module Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #222;
            color: white;
            font-family: monospace;
        }
        canvas {
            border: 2px solid #555;
            background: #000;
            width: 1280px;
            height: 960px;
            image-rendering: pixelated;
        }
        .controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h2>Render Module Test - Basic Raycasting</h2>
    <canvas id="canvas" width="640" height="480"></canvas>
    <div class="controls">
        <strong>Status:</strong> <span id="status">Loading modules...</span><br>
        <strong>Controls:</strong> WASD to move, Arrow keys to turn<br>
        <strong>Test:</strong> Basic raycasting with walls and sprites<br>
    </div>

    <script type="module">
        // Import modules
        import { 
            textures, 
            sounds, 
            texturesLoaded, 
            loadAllAssets, 
            playSound
        } from './assets.js';
        
        import { 
            MAP_WIDTH, 
            MAP_HEIGHT, 
            TILE_SIZE, 
            map, 
            isWall, 
            isWallNear
        } from './map.js';
        
        import {
            SCREEN_WIDTH,
            SCREEN_HEIGHT,
            HUD_HEIGHT,
            initRenderer,
            render,
            castRay,
            applyScreenShake,
            updateScreenShake
        } from './render.js';

        // Update status
        document.getElementById('status').textContent = 'Modules imported, loading assets...';

        // Initialize canvas
        const canvas = document.getElementById('canvas');
        const ctx = initRenderer(canvas);

        // Simple player object for testing
        const player = {
            x: 1.5 * TILE_SIZE,
            y: 1.5 * TILE_SIZE,
            dirX: 1, dirY: 0,
            planeX: 0, planeY: 0.66,
            health: 100, maxHealth: 100,
            ammo: 50, maxAmmo: 200,
            lives: 3,
            walkTimer: 0
        };

        // Simple weapon object for testing
        const weapon = {
            isVisible: true,
            state: 'ready',
            currentFrame: 1,
            upTextures: [40, 41],
            fireTextures: [42, 43]
        };

        // Test sprites
        const sprites = [
            { x: 5 * TILE_SIZE, y: 5 * TILE_SIZE, textureIndex: 8, active: true },  // Enemy sprite
            { x: 10 * TILE_SIZE, y: 10 * TILE_SIZE, textureIndex: 68, active: true }, // Health pack
            { x: 12 * TILE_SIZE, y: 8 * TILE_SIZE, textureIndex: 69, active: true }   // Ammo box
        ];

        // Input handling
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Update player movement
        function updatePlayer(deltaTime) {
            const moveSpeed = 0.003 * deltaTime;
            const rotSpeed = 0.002 * deltaTime;
            
            // Rotation
            if (keys['ArrowLeft']) {
                const oldDirX = player.dirX;
                player.dirX = player.dirX * Math.cos(rotSpeed) - player.dirY * Math.sin(rotSpeed);
                player.dirY = oldDirX * Math.sin(rotSpeed) + player.dirY * Math.cos(rotSpeed);
                const oldPlaneX = player.planeX;
                player.planeX = player.planeX * Math.cos(rotSpeed) - player.planeY * Math.sin(rotSpeed);
                player.planeY = oldPlaneX * Math.sin(rotSpeed) + player.planeY * Math.cos(rotSpeed);
            }
            if (keys['ArrowRight']) {
                const oldDirX = player.dirX;
                player.dirX = player.dirX * Math.cos(-rotSpeed) - player.dirY * Math.sin(-rotSpeed);
                player.dirY = oldDirX * Math.sin(-rotSpeed) + player.dirY * Math.cos(-rotSpeed);
                const oldPlaneX = player.planeX;
                player.planeX = player.planeX * Math.cos(-rotSpeed) - player.planeY * Math.sin(-rotSpeed);
                player.planeY = oldPlaneX * Math.sin(-rotSpeed) + player.planeY * Math.cos(-rotSpeed);
            }
            
            // Movement
            if (keys['w'] || keys['W']) {
                const newX = player.x + player.dirX * moveSpeed;
                const newY = player.y + player.dirY * moveSpeed;
                if (!isWall(newX, player.y)) player.x = newX;
                if (!isWall(player.x, newY)) player.y = newY;
                player.walkTimer += deltaTime;
            }
            if (keys['s'] || keys['S']) {
                const newX = player.x - player.dirX * moveSpeed;
                const newY = player.y - player.dirY * moveSpeed;
                if (!isWall(newX, player.y)) player.x = newX;
                if (!isWall(player.x, newY)) player.y = newY;
                player.walkTimer += deltaTime;
            }
            if (keys['a'] || keys['A']) {
                const newX = player.x - player.planeX * moveSpeed;
                const newY = player.y - player.planeY * moveSpeed;
                if (!isWall(newX, player.y)) player.x = newX;
                if (!isWall(player.x, newY)) player.y = newY;
                player.walkTimer += deltaTime;
            }
            if (keys['d'] || keys['D']) {
                const newX = player.x + player.planeX * moveSpeed;
                const newY = player.y + player.planeY * moveSpeed;
                if (!isWall(newX, player.y)) player.x = newX;
                if (!isWall(player.x, newY)) player.y = newY;
                player.walkTimer += deltaTime;
            }
            
            // Test screen shake
            if (keys[' ']) {
                applyScreenShake(10, 200);
                keys[' '] = false; // Prevent continuous shake
            }
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(currentTime) {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            updatePlayer(deltaTime);
            updateScreenShake(deltaTime);
            
            // Render the scene
            render(player, sprites, weapon, 'playing', {});
            
            // Simple HUD
            ctx.fillStyle = 'rgba(0, 0, 100, 0.8)';
            ctx.fillRect(0, SCREEN_HEIGHT - HUD_HEIGHT, SCREEN_WIDTH, HUD_HEIGHT);
            ctx.fillStyle = 'white';
            ctx.font = '16px monospace';
            ctx.textAlign = 'left';
            ctx.fillText(`Position: ${Math.floor(player.x)}, ${Math.floor(player.y)}`, 10, SCREEN_HEIGHT - 50);
            ctx.fillText(`Direction: ${player.dirX.toFixed(2)}, ${player.dirY.toFixed(2)}`, 10, SCREEN_HEIGHT - 30);
            ctx.fillText('WASD: Move, Arrows: Turn, Space: Screen Shake', 10, SCREEN_HEIGHT - 10);
            
            requestAnimationFrame(gameLoop);
        }

        // Initialize game
        async function initGame() {
            try {
                document.getElementById('status').textContent = 'Loading assets...';
                await loadAllAssets();
                
                document.getElementById('status').textContent = 'Render module loaded! Use WASD and arrows to move.';
                console.log('All modules loaded successfully!');
                
                // Start game loop
                requestAnimationFrame(gameLoop);
                
            } catch (error) {
                document.getElementById('status').textContent = 'Error loading modules: ' + error;
                console.error('Error loading modules:', error);
                
                // Draw error screen
                ctx.fillStyle = '#220000';
                ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
                ctx.fillStyle = 'red';
                ctx.font = '20px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Error loading render module', SCREEN_WIDTH/2, SCREEN_HEIGHT/2);
                ctx.fillText(error.message, SCREEN_WIDTH/2, SCREEN_HEIGHT/2 + 40);
            }
        }

        // Start initialization
        initGame();
        
    </script>
</body>
</html>